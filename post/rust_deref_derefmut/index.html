    <!DOCTYPE html>
<html lang="zh-cn">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="alenstar">
		<meta name="description" content="alenstar blog">
		<meta name="generator" content="Hugo 0.36.1" />
		<title>Rust Deref &amp; DerefMuf 类型转换 &middot; alenstar blog</title>
		<link rel="shortcut icon" href="https://alenstar.github.io/images/favicon.ico">
		<link rel="stylesheet" href="https://alenstar.github.io/css/style.css">
		<link rel="stylesheet" href="https://alenstar.github.io/css/highlight.css">
		

		
		<link rel="stylesheet" href="https://alenstar.github.io/css/font-awesome.min.css">
		

		
        
        
        
		
	</head>

    <body>
	<div class="body-box">
       <nav class="main-nav">
	
	
		<a href='https://alenstar.github.io/'> <span class="arrow">←</span>Home</a>
	
	<a href='https://alenstar.github.io/post'>Archive</a>
	<a href='https://alenstar.github.io/tags'>Tags</a>
	<a href='https://alenstar.github.io/about'>About</a>

	

	
</nav>


        <section id="wrapper">
            <article class="post">
                <header>
                    <h1>
                        Rust Deref &amp; DerefMuf 类型转换
                    </h1>
                    <h2 class="headline">
                    Jul 20, 2017 12:26
                    · 433 words
                    · 1 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="https://alenstar.github.io/tags/rust">rust</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                <section id="post-body">
                    <ol>
<li>示例代码</li>
</ol>

<pre><code>// 引入 triats Deref DerefMut
use std::ops::{Deref, DerefMut}; 

#[derive(Debug)]
pub struct Node {
    x: i32,
    y: i32,
    w: u32,
    h: u32,
}
impl Node {
    fn new(w: u32, h: u32) -&gt; Node {
        Node {
            x: 0,
            y: 0,
            w: w,
            h: h,
        }
    }
    fn get_position(&amp;self) -&gt; (i32, i32) {
        (self.x, self.y)
    }
    fn get_size(&amp;self) -&gt; (u32, u32) {
        (self.w, self.h)
    }
}

#[derive(Debug)]
pub struct Widget {
    node: Node, 
    label: String,
}

impl Widget {
    fn new(label: &amp;str, w: u32, h: u32) -&gt; Widget {
        Widget {
            node: Node {
                x: 0,
                y: 0,
                w: w,
                h: h,
            },
            label: label.to_string(),
        }
    }
    
    // 复写get_size方法
    fn get_size(&amp;self) -&gt; (u32, u32) {
        (self.w + 4, self.h + 4)
    }
}

// 为 Widget 实现 Deref 转换
impl Deref for Widget {
    type Target = Node; // 目标类型
    fn deref&lt;'a&gt;(&amp;'a self) -&gt; &amp;'a Node {
        &amp;self.node // 返回Node类型的引用
    }
}
// 为 Widget 实现 DerefMut 转换
impl DerefMut for Widget {
    fn deref_mut&lt;'a&gt;(&amp;'a mut self) -&gt; &amp;'a mut Node {
        &amp;mut self.node // 返回Node类型的可变引用
    }
}

fn main() {
    let widget = Widget::new(&quot;Cancel&quot;, 24, 64);
    println!(&quot;Widget {:?}&quot;, widget);
    // Widget类型中没有相应的属性时， 自动转换到Node类型，并访问Node的属性， 如果Node中也没有相应属性则失败
    println!(&quot;Widget {} {} {} {}&quot;, widget.x, widget.y, widget.w, widget.h); 
    // Widget没有实现 get_position 方法， 则自动转换到Node再调用 get_position 方法
    // Widget实现了 get_size 方法， 则直接调用
    println!(&quot;Widget {:?} {:?}&quot;, widget.get_position(), widget.get_size());

    let node = Node::new(24, 64);
    println!(&quot;Node {:?}&quot;, node);
    println!(&quot;Node {} {} {} {}&quot;, node.x, node.y, node.w, node.h);
    println!(&quot;Node {:?} {:?}&quot;, node.get_position(), node.get_size());
}

</code></pre>

<ol>
<li>输出结果</li>
</ol>

<pre><code>Widget Widget { node: Node { x: 0, y: 0, w: 24, h: 64 }, label: &quot;Cancel&quot; }
Widget 0 0 24 64
Widget (0, 0) (28, 68)
Node Node { x: 0, y: 0, w: 24, h: 64 }
Node 0 0 24 64
Node (0, 0) (24, 64)
</code></pre>

                </section>
            </article>
            
            
            
            

            

            

            
    
            <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="https://github.com/alenstar">
        <i class="fa fa-github-square"></i>
    </a>
    


</div>

    
    <p class="small">
    
       © Copyright 2018 <i class="fa fa-heart" aria-hidden="true"></i> alenstar
    
    </p>
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

        </section>
	</div>

	

        <script src="https://alenstar.github.io/js/jquery-2.2.4.min.js"></script>
<script src="https://alenstar.github.io/js/main.js"></script>
<script src="https://alenstar.github.io/js/highlight.min.js"></script>



<script>hljs.initHighlightingOnLoad();</script>









    </body>
</html>
