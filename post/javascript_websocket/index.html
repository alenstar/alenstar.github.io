    <!DOCTYPE html>
<html lang="zh-cn">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="alenstar">
		<meta name="description" content="alenstar blog">
		<meta name="generator" content="Hugo 0.36.1" />
		<title>websocket Javascript 客户端 &middot; alenstar blog</title>
		<link rel="shortcut icon" href="https://alenstar.github.io/images/favicon.ico">
		<link rel="stylesheet" href="https://alenstar.github.io/css/style.css">
		<link rel="stylesheet" href="https://alenstar.github.io/css/highlight.css">
		

		
		<link rel="stylesheet" href="https://alenstar.github.io/css/font-awesome.min.css">
		

		
        
        
        
		
	</head>

    <body>
	<div class="body-box">
       <nav class="main-nav">
	
	
		<a href='https://alenstar.github.io/'> <span class="arrow">←</span>Home</a>
	
	<a href='https://alenstar.github.io/post'>Archive</a>
	<a href='https://alenstar.github.io/tags'>Tags</a>
	<a href='https://alenstar.github.io/about'>About</a>

	

	
</nav>


        <section id="wrapper">
            <article class="post">
                <header>
                    <h1>
                        websocket Javascript 客户端
                    </h1>
                    <h2 class="headline">
                    May 27, 2017 16:42
                    · 532 words
                    · 2 minutes read
                      <span class="tags">
                      
                      
                          
                              <a href="https://alenstar.github.io/tags/javascript">javascript</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                <section id="post-body">
                    

<h4 id="构造方法">构造方法</h4>

<blockquote>
<p>WebSocket WebSocket(url, protocols);</p>
</blockquote>

<h4 id="参数">参数</h4>

<blockquote>
<p>url: 连接地址， ws://xxxxx:xx or wss://xxxxx:xx (tsl/ssl 加密)<br />
protocols: 可选参数</p>
</blockquote>

<h4 id="方法">方法</h4>

<p>发送数据
&gt; send(data) 支持string arraybuffer blob(二进制大对象块) 等类型数据</p>

<p>关闭连接
&gt; clsoe(code, reason) 关闭代码（默认1000），关闭原因（string）</p>

<h4 id="属性">属性</h4>

<blockquote>
<p>binaryType 二进制数据类型， &ldquo;blob&rdquo; 或者 “arraybuffer”， 可不设置<br />
onopen 回调函数， 连载建立时调用<br />
onmessage 回调函数， 收到消息时调用<br />
onclose 回调函数， 连载断开时回调<br />
onerror 回调函数， 连载出错时回调<br />
readyState 连接状态， 只读</p>
</blockquote>

<h4 id="es6封装">ES6封装</h4>

<p>定义连接状态常量</p>

<pre><code>  const WsStateDisconnected = 0; // 连接断开
  const WsStateDisconnecting = 1; // 正在断开连接
  const WsStateConnected = 2; // 连接正常
  const WsStateConnecting = 3; // 正在连接
</code></pre>

<p>构造websocket对象</p>

<pre><code>class SimpleWSocket {
    constructor(url) {
      this.wsState = WsStateDisconnected;
      this.timer = null;
      this.url = url;
      this.ws = null;
      this.isreconnect = false;
    }
}
</code></pre>

<pre><code>    connect() {
        if (this.wsState === WsStateConnected) {
          this.disconnect();
        }

      if (this.wsState !== WsStateDisconnected) {
        tlog('connection is busy')
        return
      }

      this.wsState = WsStateConnecting;
      this.ws = null;
      this.ws = new WebSocket(this.url);
      this.ws.binaryType = 'arraybuffer';

      this.ws.onmessage = function (e) {
        if (typeof e.data === 'string') {
            // TODO process string message
            // console.log('string:', e.data)
        } else {
          if (e.data.byteLength &gt; 0) {
              // TODO process arraybuffer message
          }
        }
        this.onmessage(e.data);
      }.bind(this);

      this.ws.onclose = function (e) {
        tlog(e);
        this.wsState = WsStateDisconnected;
        this.onclose();

        if (this.isreconnect) {
          if (typeof this.timer !== 'undefined' || this.timer !== null) {
            clearInterval(this.timer);
            this.timer = null;
          }

          this.timer = setInterval(function () {
            if (this.isconnected() == false) {
              this.connect();
            }
          }.bind(this), 5000);
        }
      }.bind(this);

      this.ws.onerror = function (e) {
        // TODO
        this.disconnect();
      }.bind(this);

      this.ws.onopen = function (e) {
        this.wsState = WsStateConnected;
        if (this.wsState === WsStateConnected) {
          this.onopen();
        } else {
          tlog('connection is closed or closing')
        }
      }.bind(this);
    }
</code></pre>

<pre><code>    disconnect() {
      this.setreconnect(false);
      if (this.ws !== null) {
        if (this.wsState === WsStateConnected) {
          this.onclose();
          this.wsState = WsStateDisconnecting;
          this.ws.close(1000, 'doclose');
        } else {
          tlog('connection is not complete');
        }
      } else {
        tlog('WebSocket session is null');
      }
    }

    isconnected() {
      return this.wsState === WsStateConnected ? true : false;
    }

    setreconnect(ok) {
      if (ok) {
        this.isreconnect = true;
      } else {
        this.isreconnect = false;
        if (typeof this.timer !== 'undefined' || this.timer !== null) {
          clearInterval(this.timer);
          this.timer = null;
        }
      }
    }

    postmessage(message) {
      if (this.wsState === WsStateConnected) {
          this.ws.send(message);
      } else {
        console.log('connection is closed or closing')
      }
    }

</code></pre>

<p>继承实现自定义处理方法</p>

<pre><code>class SimpleWSocket {
    // virtual function
    onclose() {
      // TODO
    }

    // virtual function
    onopen() {
      // TODO
    }

    // message dispatch // virtual function
    onmessage(message) {
        // TODO
    }
  }

</code></pre>

                </section>
            </article>
            
            
            
            

            

            

            
    
            <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="https://github.com/alenstar">
        <i class="fa fa-github-square"></i>
    </a>
    


</div>

    
    <p class="small">
    
       © Copyright 2018 <i class="fa fa-heart" aria-hidden="true"></i> alenstar
    
    </p>
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

        </section>
	</div>

	

        <script src="https://alenstar.github.io/js/jquery-2.2.4.min.js"></script>
<script src="https://alenstar.github.io/js/main.js"></script>
<script src="https://alenstar.github.io/js/highlight.min.js"></script>



<script>hljs.initHighlightingOnLoad();</script>









    </body>
</html>
